from audits.wad import wad
import docker
from io import BytesIO
import tarfile
from time import sleep
from primitives import sort_to_ver
import json


def show_exploit(data):
    data = wad.wad(data)
    if len(data) == 0:
        return 'Not data'

    if data == 'Not data':
        return 'Not data'

    list_command = []
    for element in data:
        command_str = ''
        for key, value in element.items():
            if key == 'app':
                command_str += value
                command_str += " "
            if key == 'ver':
                if value is None:
                    break
                command_str += sort_to_ver(value)
        else:
            list_command.append(command_str)

    client = docker.from_env()
    data = client.containers.run("deep_analize/show_exploit:1.0",
                                 list_command,
                                 detach=True)
    sleep(5)
    file_json = data.get_archive('/wd/out.json')
    stream, stat = file_json
    file_obj = BytesIO()
    for i in stream:
        file_obj.write(i)
    file_obj.seek(0)
    tar = tarfile.open(mode='r', fileobj=file_obj)
    text = tar.extractfile('out.json')
    res = text.read()
    q = res.decode('utf-8')
    q = json.loads(q)

    res = {}
    for key, value in q.items():
        for i in value['RESULTS_EXPLOIT']:
            if ror(key, i['Title']):
                res[i['Title'].replace('.', 'ï¼Ž')] = i['URL']
            else:
                continue

    return {'command': list_command, 'res': res}


def ror(key, title):
    key = key.lower()
    key = key.split(' ')
    title = title.lower()
    if key[0] in title and key[1] in title:
        return True
